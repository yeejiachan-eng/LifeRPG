<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeRPG - 人生 RPG</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts (Inter & Noto Sans TC) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #020617; /* slate-950 */
            color: #f1f5f9; /* slate-100 */
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Custom Scrollbar hiding */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Animations */
        @keyframes bounce {
            0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8,0,1,1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0,0,0.2,1); }
        }
        .animate-bounce { animation: bounce 1s infinite; }
        
        @keyframes slide-in {
            from { transform: translate(-50%, 100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        .animate-slide-in { animation: slide-in 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import * as LucideReact from "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0";

        const { 
            Trophy, Zap, CheckCircle2, Plus, Trash2, Dumbbell, BookOpen, Home, 
            TrendingUp, Lock, Unlock, Star, RefreshCw, X, Briefcase, Heart, 
            Calendar, Clock, Repeat, Download, Filter, HardHat, Info 
        } = LucideReact;

        // --- Components ---

        const Card = ({ children, className = "" }) => (
            <div className={`bg-slate-800 border border-slate-700 rounded-xl shadow-xl overflow-hidden ${className}`}>
                {children}
            </div>
        );

        const Button = ({ onClick, children, variant = "primary", className = "", disabled = false }) => {
            const variants = {
                primary: "bg-indigo-600 hover:bg-indigo-500 text-white",
                secondary: "bg-slate-700 hover:bg-slate-600 text-slate-200",
                danger: "bg-red-500/20 hover:bg-red-500/40 text-red-400 border border-red-500/50",
                success: "bg-emerald-600 hover:bg-emerald-500 text-white",
                outline: "border border-slate-600 text-slate-400 hover:bg-slate-700 hover:text-white"
            };
            
            return (
                <button 
                    onClick={onClick}
                    disabled={disabled}
                    className={`px-4 py-2 rounded-lg font-medium transition-all active:scale-95 flex items-center justify-center gap-2 ${variants[variant]} ${className} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
                >
                    {children}
                </button>
            );
        };

        const ProgressBar = ({ current, max, colorClass = "bg-indigo-500", height = "h-2" }) => {
            const percentage = Math.min(100, Math.max(0, (current / max) * 100));
            return (
                <div className={`${height} w-full bg-slate-900 rounded-full overflow-hidden border border-slate-700`}>
                    <div 
                        className={`h-full transition-all duration-500 ease-out ${colorClass}`}
                        style={{ width: `${percentage}%` }}
                    />
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
                    <div className="bg-slate-800 border border-slate-600 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100">
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center">
                            <h3 className="text-xl font-bold text-white">{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><X size={24} /></button>
                        </div>
                        <div className="p-6">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const Notification = ({ message, type, onClose }) => {
            if (!message) return null;
            
            const bgColors = {
                success: "bg-emerald-600",
                error: "bg-red-600",
                info: "bg-indigo-600"
            };

            return (
                <div className={`fixed bottom-6 left-1/2 transform -translate-x-1/2 z-[60] flex items-center gap-3 px-6 py-3 rounded-full shadow-2xl text-white ${bgColors[type] || bgColors.info} animate-slide-in`}>
                    <span>{message}</span>
                    <button onClick={onClose} className="opacity-80 hover:opacity-100"><X size={16} /></button>
                </div>
            );
        };

        // --- Main App Component ---

        function LifeRPG() {
            const [user, setUser] = React.useState(() => {
                const saved = localStorage.getItem('liferpg-user-v2');
                if (saved) return JSON.parse(saved);
                return {
                    base: { level: 1, xp: 0, maxXp: 100 },
                    job: { level: 1, xp: 0, maxXp: 100 },
                    totalTasksCompleted: 0
                };
            });

            // Helper for week number
            function getWeekNumber(d) {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
                return weekNo;
            }

            const [appState, setAppState] = React.useState(() => {
                const saved = localStorage.getItem('liferpg-app-state');
                return saved ? JSON.parse(saved) : {
                    lastVisitDate: new Date().toDateString(),
                    lastVisitWeek: getWeekNumber(new Date())
                };
            });

            const [tasks, setTasks] = React.useState(() => {
                const saved = localStorage.getItem('liferpg-tasks');
                return saved ? JSON.parse(saved) : [
                    { id: 1, title: "遛狗", category: "fitness", xp: 30, completed: false, repeat: 'daily' },
                    { id: 2, title: "健身/運動", category: "fitness", xp: 50, completed: false, repeat: 'daily' },
                    { id: 3, title: "洗衣服", category: "chores", xp: 40, completed: false, repeat: 'weekly' },
                ];
            });

            const [rewards, setRewards] = React.useState(() => {
                const saved = localStorage.getItem('liferpg-rewards-v2');
                return saved ? JSON.parse(saved) : [
                    { id: 1, title: "放縱餐 (Cheat Meal)", reqType: 'base', levelReq: 2, unlocked: false },
                    { id: 2, title: "買新遊戲", reqType: 'job', levelReq: 5, unlocked: false },
                ];
            });

            const [history, setHistory] = React.useState(() => {
                const saved = localStorage.getItem('liferpg-history');
                return saved ? JSON.parse(saved) : [];
            });

            const [activeTab, setActiveTab] = React.useState('tasks');
            const [questFilter, setQuestFilter] = React.useState('all'); 
            const [levelUpData, setLevelUpData] = React.useState(null);
            const [notification, setNotification] = React.useState(null); 
            
            const [newTask, setNewTask] = React.useState({ title: '', category: 'fitness', xp: 20, repeat: 'daily' });
            const [newReward, setNewReward] = React.useState({ title: '', reqType: 'base', levelReq: 2 });

            // --- Config ---
             const categories = {
                fitness: { type: 'base', color: "text-red-400", bg: "bg-red-500/10", border: "border-red-500/20", icon: <Dumbbell size={18} />, label: "運動健康" },
                chores: { type: 'base', color: "text-blue-400", bg: "bg-blue-500/10", border: "border-blue-500/20", icon: <Home size={18} />, label: "居家雜務" },
                knowledge: { type: 'job', color: "text-purple-400", bg: "bg-purple-500/10", border: "border-purple-500/20", icon: <BookOpen size={18} />, label: "專業知識" },
                finance: { type: 'job', color: "text-emerald-400", bg: "bg-emerald-500/10", border: "border-emerald-500/20", icon: <TrendingUp size={18} />, label: "理財投資" },
                general: { type: 'base', color: "text-slate-400", bg: "bg-slate-500/10", border: "border-slate-500/20", icon: <Star size={18} />, label: "一般任務" },
            };

            const showNotification = (message, type = 'info') => {
                setNotification({ message, type });
                setTimeout(() => setNotification(null), 3000);
            };

            // --- Effects ---
            React.useEffect(() => { localStorage.setItem('liferpg-user-v2', JSON.stringify(user)); }, [user]);
            React.useEffect(() => { localStorage.setItem('liferpg-tasks', JSON.stringify(tasks)); }, [tasks]);
            React.useEffect(() => { localStorage.setItem('liferpg-rewards-v2', JSON.stringify(rewards)); }, [rewards]);
            React.useEffect(() => { localStorage.setItem('liferpg-history', JSON.stringify(history)); }, [history]);
            React.useEffect(() => { localStorage.setItem('liferpg-app-state', JSON.stringify(appState)); }, [appState]);

            React.useEffect(() => {
                const today = new Date();
                const todayString = today.toDateString();
                const currentWeek = getWeekNumber(today);

                let updatedTasks = [...tasks];
                let tasksChanged = false;

                if (appState.lastVisitDate !== todayString) {
                    updatedTasks = updatedTasks.map(t => {
                        if (t.repeat === 'daily' && t.completed) {
                            tasksChanged = true;
                            return { ...t, completed: false };
                        }
                        return t;
                    });
                }

                if (appState.lastVisitWeek !== currentWeek) {
                    updatedTasks = updatedTasks.map(t => {
                        if (t.repeat === 'weekly' && t.completed) {
                            tasksChanged = true;
                            return { ...t, completed: false };
                        }
                        return t;
                    });
                }

                if (tasksChanged) {
                    setTasks(updatedTasks);
                    showNotification("每日/每週任務已重置！", "info");
                }

                setAppState({
                    lastVisitDate: todayString,
                    lastVisitWeek: currentWeek
                });
            }, []);

            // --- Logic ---

            const handleCompleteTask = (taskId) => {
                const task = tasks.find(t => t.id === taskId);
                if (task.completed) return;

                setTasks(tasks.map(t => 
                    t.id === taskId ? { ...t, completed: true } : t
                ));

                const historyEntry = {
                    logId: Date.now(),
                    title: task.title,
                    category: task.category,
                    xp: task.xp,
                    completedAt: new Date().toISOString()
                };
                setHistory(prev => [historyEntry, ...prev]);

                addXP(task.xp, task.category);
            };

            const addXP = (amount, categoryKey) => {
                const category = categories[categoryKey] || categories.general;
                const type = category.type;

                setUser(prev => {
                    let currentStats = { ...prev[type] };
                    let newXP = currentStats.xp + amount;
                    let newLevel = currentStats.level;
                    let newMaxXp = currentStats.maxXp;
                    let leveledUp = false;

                    while (newXP >= newMaxXp) {
                        newXP -= newMaxXp;
                        newLevel++;
                        newMaxXp = Math.floor(newMaxXp * 1.2);
                        leveledUp = true;
                    }

                    if (leveledUp) {
                        setTimeout(() => setLevelUpData({ type, level: newLevel }), 100);
                    }

                    return {
                        ...prev,
                        [type]: {
                            level: newLevel,
                            xp: newXP,
                            maxXp: newMaxXp
                        },
                        totalTasksCompleted: prev.totalTasksCompleted + 1
                    };
                });
            };

            const handleManualReset = () => {
                if(window.confirm("確定要強制重置所有任務為「未完成」嗎？")) {
                    setTasks(tasks.map(t => ({ ...t, completed: false })));
                    showNotification("所有任務已強制重置為未完成", "info");
                }
            };

            const handleDeleteTask = (id) => {
                setTasks(tasks.filter(t => t.id !== id));
                showNotification("任務已刪除", "error");
            };

            const handleAddTask = (e) => {
                e.preventDefault();
                if (!newTask.title.trim()) return;
                
                setTasks([...tasks, {
                    id: Date.now(),
                    title: newTask.title,
                    category: newTask.category,
                    xp: parseInt(newTask.xp),
                    repeat: newTask.repeat,
                    completed: false
                }]);
                setNewTask({ title: '', category: 'fitness', xp: 20, repeat: 'daily' });
                showNotification("新任務已新增！", "success");
            };

            const handleAddReward = (e) => {
                e.preventDefault();
                if (!newReward.title.trim()) return;

                setRewards([...rewards, {
                    id: Date.now(),
                    title: newReward.title,
                    reqType: newReward.reqType,
                    levelReq: parseInt(newReward.levelReq),
                    unlocked: false
                }]);
                setNewReward(prev => ({ ...prev, title: '' }));
                showNotification("新獎勵已新增！", "success");
            };

            const handleDeleteReward = (id) => {
                setRewards(rewards.filter(r => r.id !== id));
            };

            const handleClearHistory = () => {
                if(window.confirm("確定要清除所有紀錄嗎？")) {
                    setHistory([]);
                    showNotification("歷史紀錄已清除", "info");
                }
            };

            const handleImportStarterPack = () => {
                if(!window.confirm("匯入新手包任務？")) return;
                const starterPack = [
                    { id: 1001, title: "遛狗", category: "fitness", xp: 30, completed: false, repeat: 'daily' },
                    { id: 1002, title: "健身/運動", category: "fitness", xp: 50, completed: false, repeat: 'daily' },
                    { id: 1003, title: "洗衣服", category: "chores", xp: 40, completed: false, repeat: 'weekly' },
                    { id: 1004, title: "更換床單", category: "chores", xp: 40, completed: false, repeat: 'weekly' },
                    { id: 1005, title: "吸地板", category: "chores", xp: 30, completed: false, repeat: 'weekly' },
                    { id: 1006, title: "拖地", category: "chores", xp: 30, completed: false, repeat: 'weekly' },
                    { id: 1007, title: "倒垃圾", category: "chores", xp: 10, completed: false, repeat: 'daily' },
                    { id: 1008, title: "喝水 2000cc", category: "fitness", xp: 10, completed: false, repeat: 'daily' },
                    { id: 1009, title: "檢視每日開銷", category: "finance", xp: 20, completed: false, repeat: 'daily' },
                    { id: 1010, title: "閱讀產業新聞", category: "knowledge", xp: 20, completed: false, repeat: 'daily' },
                    { id: 1011, title: "刷牙用牙線", category: "fitness", xp: 10, completed: false, repeat: 'daily' },
                    { id: 1012, title: "冥想 (10分鐘)", category: "fitness", xp: 15, completed: false, repeat: 'daily' },
                    { id: 1013, title: "打電話給家人/朋友", category: "general", xp: 25, completed: false, repeat: 'weekly' },
                ];

                const uniqueNewTasks = starterPack.filter(newItem => 
                    !tasks.some(existing => existing.title.trim() === newItem.title.trim())
                );

                if (uniqueNewTasks.length === 0) {
                    showNotification("你已經擁有這些新手任務了！", "info");
                    return;
                }

                setTasks(prev => [...prev, ...uniqueNewTasks.map(t => ({...t, id: Date.now() + Math.random()}))]);
                showNotification(`成功匯入 ${uniqueNewTasks.length} 個新手任務！`, "success");
            };

            const handleImportEngineerPack = () => {
                if(!window.confirm("匯入環工與理財任務？")) return;
                const engineerPack = [
                    { id: 2001, title: "考取環工技師執照 (PE)", category: "knowledge", xp: 100, completed: false, repeat: 'none' },
                    { id: 2002, title: "取得甲級證照 (空/水/廢)", category: "knowledge", xp: 50, completed: false, repeat: 'none' },
                    { id: 2003, title: "精通 QGIS/ArcGIS 自動化", category: "knowledge", xp: 50, completed: false, repeat: 'none' },
                    { id: 2004, title: "番茄鐘寫環評 (4x25分鐘)", category: "knowledge", xp: 20, completed: false, repeat: 'daily' },
                    { id: 2005, title: "查詢環保署法規更新", category: "knowledge", xp: 10, completed: false, repeat: 'daily' },
                    { id: 2006, title: "零支出挑戰 (No-Spend)", category: "finance", xp: 30, completed: false, repeat: 'daily' },
                    { id: 2007, title: "學習新工具 (AERMOD/噪音)", category: "knowledge", xp: 40, completed: false, repeat: 'weekly' },
                    { id: 2008, title: "轉帳預售屋工程款", category: "finance", xp: 50, completed: false, repeat: 'weekly' },
                    { id: 2009, title: "伴侶理財會議", category: "finance", xp: 30, completed: false, repeat: 'weekly' },
                    { id: 2010, title: "閱讀一篇高股息 ETF 文章", category: "finance", xp: 20, completed: false, repeat: 'none' },
                ];

                const uniqueNewTasks = engineerPack.filter(newItem => 
                    !tasks.some(existing => existing.title.trim() === newItem.title.trim())
                );

                if (uniqueNewTasks.length === 0) {
                    showNotification("你已經擁有這些工程師任務了！", "info");
                    return;
                }

                setTasks(prev => [...prev, ...uniqueNewTasks.map(t => ({...t, id: Date.now() + Math.random()}))]);
                showNotification(`成功匯入 ${uniqueNewTasks.length} 個環工/理財任務！`, "success");
            };

            const getHistoryByDate = () => {
                const groups = {};
                history.forEach(entry => {
                    const date = new Date(entry.completedAt).toLocaleDateString('zh-TW', {
                        year: 'numeric', month: 'short', day: 'numeric', weekday: 'short'
                    });
                    if (!groups[date]) groups[date] = [];
                    groups[date].push(entry);
                });
                return groups;
            };

            // --- UI Render ---
            const filteredTasks = tasks.filter(task => {
                if (questFilter === 'all') return true;
                const cat = categories[task.category] || categories.general;
                return cat.type === questFilter;
            });

            return (
                <div className="min-h-screen">
                    {notification && (
                        <Notification message={notification.message} type={notification.type} onClose={() => setNotification(null)} />
                    )}

                    {/* Header */}
                    <div className="bg-slate-900 border-b border-slate-800 sticky top-0 z-30 shadow-2xl">
                        <div className="max-w-3xl mx-auto p-4 space-y-4">
                            <div className="flex items-center justify-between">
                                <h1 className="text-2xl font-bold bg-gradient-to-r from-indigo-400 to-cyan-400 bg-clip-text text-transparent">
                                    人生 RPG
                                </h1>
                                <div className="text-xs text-slate-500 font-mono">
                                    已完成 {user.totalTasksCompleted} 個任務
                                </div>
                            </div>

                            {/* Levels */}
                            <div className="space-y-1">
                                <div className="flex justify-between text-xs font-bold uppercase tracking-wider">
                                    <span className="flex items-center gap-1 text-rose-400"><Heart size={12} /> 基礎等級 (生活) LV {user.base.level}</span>
                                    <span className="text-slate-500">{user.base.xp} / {user.base.maxXp} XP</span>
                                </div>
                                <ProgressBar current={user.base.xp} max={user.base.maxXp} colorClass="bg-gradient-to-r from-rose-500 to-pink-500" height="h-3" />
                            </div>
                            <div className="space-y-1">
                                <div className="flex justify-between text-xs font-bold uppercase tracking-wider">
                                    <span className="flex items-center gap-1 text-cyan-400"><Briefcase size={12} /> 職涯等級 (工作) LV {user.job.level}</span>
                                    <span className="text-slate-500">{user.job.xp} / {user.job.maxXp} XP</span>
                                </div>
                                <ProgressBar current={user.job.xp} max={user.job.maxXp} colorClass="bg-gradient-to-r from-cyan-500 to-blue-500" height="h-3" />
                            </div>
                        </div>
                    </div>

                    <main className="max-w-3xl mx-auto p-4 pb-24">
                        
                        {/* Tabs */}
                        <div className="flex gap-2 mb-6 overflow-x-auto pb-2 scrollbar-hide">
                            <button onClick={() => setActiveTab('tasks')} className={`flex-1 py-3 min-w-[100px] rounded-lg font-bold transition-all flex items-center justify-center gap-2 ${activeTab === 'tasks' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/20' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
                                <CheckCircle2 size={20} /> 任務列表
                            </button>
                            <button onClick={() => setActiveTab('rewards')} className={`flex-1 py-3 min-w-[100px] rounded-lg font-bold transition-all flex items-center justify-center gap-2 ${activeTab === 'rewards' ? 'bg-amber-600 text-white shadow-lg shadow-amber-500/20' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
                                <Trophy size={20} /> 獎勵兌換
                            </button>
                            <button onClick={() => setActiveTab('history')} className={`flex-1 py-3 min-w-[100px] rounded-lg font-bold transition-all flex items-center justify-center gap-2 ${activeTab === 'history' ? 'bg-teal-600 text-white shadow-lg shadow-teal-500/20' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
                                <Calendar size={20} /> 歷史紀錄
                            </button>
                        </div>

                        {/* --- TASKS TAB --- */}
                        {activeTab === 'tasks' && (
                            <div className="space-y-6 animate-slide-in">
                                <div className="bg-slate-900 p-1 rounded-xl border border-slate-800 flex">
                                    <button onClick={() => setQuestFilter('all')} className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-2 ${questFilter === 'all' ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white'}`}>全部</button>
                                    <button onClick={() => setQuestFilter('base')} className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-2 ${questFilter === 'base' ? 'bg-rose-600 text-white' : 'text-slate-400 hover:text-white'}`}><Heart size={14} /> 基礎</button>
                                    <button onClick={() => setQuestFilter('job')} className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-2 ${questFilter === 'job' ? 'bg-cyan-600 text-white' : 'text-slate-400 hover:text-white'}`}><Briefcase size={14} /> 職涯</button>
                                </div>

                                <Card className="p-4 bg-slate-900/50">
                                    <form onSubmit={handleAddTask} className="flex flex-col gap-3">
                                        <div className="flex flex-col sm:flex-row gap-3">
                                            <input type="text" placeholder="輸入任務名稱..." className="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-indigo-500 text-white" value={newTask.title} onChange={(e) => setNewTask({...newTask, title: e.target.value})} />
                                            <select className="bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-slate-300 focus:outline-none" value={newTask.category} onChange={(e) => setNewTask({...newTask, category: e.target.value})}>
                                                {Object.entries(categories).map(([key, val]) => <option key={key} value={key}>{val.label}</option>)}
                                            </select>
                                        </div>
                                        <div className="flex flex-col sm:flex-row gap-3">
                                            <select className="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-slate-300 focus:outline-none" value={newTask.repeat} onChange={(e) => setNewTask({...newTask, repeat: e.target.value})}>
                                                <option value="daily">每日重複</option>
                                                <option value="weekly">每週重複</option>
                                                <option value="none">一次性</option>
                                            </select>
                                            <select className="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-slate-300 focus:outline-none" value={newTask.xp} onChange={(e) => setNewTask({...newTask, xp: e.target.value})}>
                                                <option value="10">10 XP (簡單)</option>
                                                <option value="20">20 XP (普通)</option>
                                                <option value="30">30 XP (困難)</option>
                                                <option value="50">50 XP (史詩)</option>
                                            </select>
                                            <Button variant="primary"><Plus size={20} /> 新增</Button>
                                        </div>
                                    </form>
                                </Card>

                                <div className="flex justify-between items-center flex-wrap gap-2">
                                    <h2 className="text-xl font-bold text-white">進行中 ({filteredTasks.length})</h2>
                                    <div className="flex gap-2">
                                        <button onClick={handleImportEngineerPack} className="text-xs flex items-center gap-1 text-cyan-400 hover:text-white bg-cyan-500/10 px-2 py-1 rounded border border-cyan-500/20"><HardHat size={12} /> 匯入環工包</button>
                                        <button onClick={handleImportStarterPack} className="text-xs flex items-center gap-1 text-indigo-400 hover:text-white"><Download size={12} /> 匯入新手包</button>
                                        <button onClick={handleManualReset} className="text-xs flex items-center gap-1 text-slate-400 hover:text-white"><RefreshCw size={12} /> 強制重置</button>
                                    </div>
                                </div>

                                <div className="space-y-3">
                                    {filteredTasks.length === 0 && <div className="text-center py-12 text-slate-500 italic">此分類暫無任務。</div>}
                                    {filteredTasks.sort((a,b) => (a.completed === b.completed) ? 0 : a.completed ? 1 : -1).map((task) => {
                                        const cat = categories[task.category] || categories.general;
                                        const xpType = cat.type === 'base' ? '基礎' : '職涯';
                                        const xpColor = cat.type === 'base' ? 'text-rose-400' : 'text-cyan-400';
                                        
                                        return (
                                            <div key={task.id} className={`relative group flex items-center justify-between p-4 rounded-xl border transition-all duration-300 ${task.completed ? 'bg-slate-900/50 border-slate-800 opacity-60' : `bg-slate-800 ${cat.border} shadow-lg`}`}>
                                                <div className="flex items-center gap-4 overflow-hidden">
                                                    <button onClick={() => handleCompleteTask(task.id)} disabled={task.completed} className={`shrink-0 h-12 w-12 rounded-full flex items-center justify-center border-2 transition-all ${task.completed ? 'bg-green-500/20 border-green-500 text-green-500' : 'bg-slate-700 border-slate-600 text-slate-500'}`}>
                                                        {task.completed ? <CheckCircle2 size={24} /> : <div className="h-4 w-4 rounded-full bg-current opacity-20" />}
                                                    </button>
                                                    <div className="min-w-0">
                                                        <div className="flex flex-wrap items-center gap-2 mb-1">
                                                            <span className={`text-xs font-bold px-2 py-0.5 rounded-full flex items-center gap-1 ${cat.color} ${cat.bg}`}>{cat.icon} {cat.label}</span>
                                                            <span className={`text-xs font-mono ${xpColor}`}>+{task.xp} {xpType} XP</span>
                                                            {task.repeat && task.repeat !== 'none' && <span className="text-xs text-slate-500 flex items-center gap-1"><Repeat size={10} /> {task.repeat === 'daily' ? '每日' : '每週'}</span>}
                                                        </div>
                                                        <h3 className={`font-medium truncate ${task.completed ? 'line-through text-slate-500' : 'text-white'}`}>{task.title}</h3>
                                                    </div>
                                                </div>
                                                <button onClick={() => handleDeleteTask(task.id)} className="opacity-0 group-hover:opacity-100 transition-opacity p-2 text-slate-500 hover:text-red-400"><Trash2 size={18} /></button>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* --- REWARDS TAB --- */}
                        {activeTab === 'rewards' && (
                            <div className="space-y-6 animate-slide-in">
                                <Card className="p-4 bg-slate-900/50">
                                    <div className="flex flex-col gap-3">
                                        <input type="text" placeholder="輸入獎勵名稱..." className="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-amber-500 text-white" value={newReward.title} onChange={(e) => setNewReward({...newReward, title: e.target.value})} />
                                        <div className="flex gap-3">
                                            <select className="bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-slate-300 focus:outline-none" value={newReward.reqType} onChange={(e) => setNewReward({...newReward, reqType: e.target.value})}>
                                                <option value="base">基礎等級</option>
                                                <option value="job">職涯等級</option>
                                            </select>
                                            <input type="number" min="1" className="bg-slate-800 border border-slate-600 rounded-lg px-3 w-20 text-white focus:outline-none" value={newReward.levelReq} onChange={(e) => setNewReward({...newReward, levelReq: e.target.value})} />
                                            <Button variant="primary" onClick={handleAddReward}><Plus size={20} /></Button>
                                        </div>
                                    </div>
                                </Card>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    {rewards.sort((a,b) => a.levelReq - b.levelReq).map((reward) => {
                                        const reqTypeLabel = reward.reqType === 'base' ? '基礎' : '職涯';
                                        const userLevel = reward.reqType === 'base' ? user.base.level : user.job.level;
                                        const isUnlocked = userLevel >= reward.levelReq;
                                        return (
                                            <div key={reward.id} className={`relative p-5 rounded-xl border flex flex-col gap-3 ${isUnlocked ? 'bg-gradient-to-br from-amber-900/20 to-slate-800 border-amber-500/30' : 'bg-slate-800 border-slate-700 opacity-75'}`}>
                                                <div className="flex justify-between items-start">
                                                    <div className={`p-3 rounded-lg ${isUnlocked ? 'bg-amber-500/20 text-amber-400' : 'bg-slate-700 text-slate-500'}`}>{isUnlocked ? <Unlock size={24} /> : <Lock size={24} />}</div>
                                                    <button onClick={() => handleDeleteReward(reward.id)} className="text-slate-600 hover:text-red-400"><Trash2 size={16} /></button>
                                                </div>
                                                <div>
                                                    <h3 className={`font-bold text-lg ${isUnlocked ? 'text-white' : 'text-slate-400'}`}>{reward.title}</h3>
                                                    <p className={`text-sm mt-1 font-mono ${isUnlocked ? 'text-green-400' : 'text-red-400'}`}>{isUnlocked ? '已解鎖' : `需要 ${reqTypeLabel}等級 ${reward.levelReq}`}</p>
                                                </div>
                                                {!isUnlocked && <ProgressBar current={userLevel} max={reward.levelReq} colorClass="bg-slate-500" />}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* --- HISTORY TAB --- */}
                        {activeTab === 'history' && (
                            <div className="space-y-6 animate-slide-in">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-xl font-bold text-white">任務時間軸</h2>
                                    <button onClick={handleClearHistory} className="text-xs flex items-center gap-1 text-slate-400 hover:text-red-400"><Trash2 size={12} /> 清除紀錄</button>
                                </div>
                                {history.length === 0 ? (
                                    <div className="text-center py-12 text-slate-500 italic border border-dashed border-slate-800 rounded-xl">尚未有紀錄。</div>
                                ) : (
                                    <div className="space-y-8 relative before:absolute before:left-4 before:top-2 before:bottom-2 before:w-0.5 before:bg-slate-800">
                                        {Object.entries(getHistoryByDate()).map(([date, entries]) => (
                                            <div key={date} className="relative pl-10">
                                                <div className="absolute left-2 top-0 w-4 h-4 bg-slate-700 rounded-full border-4 border-slate-950 transform -translate-x-1/2 z-10"></div>
                                                <div className="mb-4"><span className="text-sm font-bold text-slate-400 uppercase bg-slate-900/80 px-2 py-1 rounded">{date}</span></div>
                                                <div className="space-y-3">
                                                    {entries.sort((a,b) => new Date(b.completedAt) - new Date(a.completedAt)).map(entry => {
                                                        const cat = categories[entry.category] || categories.general;
                                                        return (
                                                            <div key={entry.logId} className="bg-slate-900 border border-slate-800 p-3 rounded-lg flex items-center justify-between shadow-sm">
                                                                <div className="flex items-center gap-3">
                                                                    <div className={`p-2 rounded-full ${cat.bg} ${cat.color}`}>{cat.icon}</div>
                                                                    <div>
                                                                        <div className="text-slate-200 font-medium">{entry.title}</div>
                                                                        <div className="text-xs text-slate-500">{new Date(entry.completedAt).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}</div>
                                                                    </div>
                                                                </div>
                                                                <div className="font-mono text-xs text-indigo-400">+{entry.xp} XP</div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                    </main>

                    {/* Level Up Modal */}
                    <Modal isOpen={!!levelUpData} onClose={() => setLevelUpData(null)} title={`${levelUpData?.type === 'base' ? '基礎' : '職涯'}等級升級！`}>
                        <div className="text-center space-y-6">
                            <div className={`mx-auto h-24 w-24 rounded-full flex items-center justify-center animate-bounce ${levelUpData?.type === 'base' ? 'bg-rose-500 shadow-[0_0_30px_rgba(244,63,94,0.5)]' : 'bg-cyan-500 shadow-[0_0_30px_rgba(6,182,212,0.5)]'}`}>
                                {levelUpData?.type === 'base' ? <Heart size={48} className="text-white" /> : <Briefcase size={48} className="text-white" />}
                            </div>
                            <div>
                                <h2 className="text-4xl font-black text-white mb-2">{levelUpData?.level}</h2>
                                <p className="text-slate-300">恭喜！你達到了新的等級！</p>
                            </div>
                            <Button onClick={() => setLevelUpData(null)} variant="primary" className="w-full py-3 text-lg">繼續旅程</Button>
                        </div>
                    </Modal>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LifeRPG />);
    </script>
</body>
</html>