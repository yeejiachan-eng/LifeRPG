<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- 視口設定：確保在所有手機上正確縮放且不被瀏海遮擋 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LifeRPG</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- 基礎設定 --- */
        html, body {
            margin: 0;
            padding: 0;
            background-color: #020617;
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            color: #f1f5f9;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden; /* 禁止瀏覽器層級捲動 */
            width: 100%;
            height: 100%;
            position: fixed; /* 鎖定畫面 */
        }

        #root {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* 允許垂直捲動 */
            overflow-x: hidden; /* 禁止水平捲動 */
            -webkit-overflow-scrolling: touch;
        }

        /* 防止輸入框點擊時放大 */
        input, select, textarea {
            font-size: 16px !important; 
        }

        /* 隱藏捲軸 */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* 安全區域 */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: max(1rem, env(safe-area-inset-top)); }

        /* 動畫 */
        @keyframes bounce {
            0%, 100% { transform: translateY(-25%); }
            50% { transform: translateY(0); }
        }
        .animate-bounce { animation: bounce 1s infinite; }
        
        @keyframes slide-in {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-in { animation: slide-in 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import * as LucideReact from "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0";

        const { 
            Trophy, Zap, CheckCircle2, Plus, Trash2, Dumbbell, BookOpen, Home, 
            TrendingUp, Lock, Unlock, Star, RefreshCw, X, Briefcase, Heart, 
            Calendar, Clock, Repeat, Download, Filter, HardHat, Info, Settings, Upload, Save
        } = LucideReact;

        // --- UI 元件 ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-slate-800 border border-slate-700 rounded-xl shadow-xl overflow-hidden w-full ${className}`}>
                {children}
            </div>
        );

        const Button = ({ onClick, children, variant = "primary", className = "", disabled = false }) => {
            const variants = {
                primary: "bg-indigo-600 hover:bg-indigo-500 text-white",
                secondary: "bg-slate-700 hover:bg-slate-600 text-slate-200",
                danger: "bg-red-500/20 hover:bg-red-500/40 text-red-400 border border-red-500/50",
                success: "bg-emerald-600 hover:bg-emerald-500 text-white",
                outline: "border border-slate-600 text-slate-400 hover:bg-slate-700 hover:text-white"
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`px-4 py-3 rounded-lg font-medium transition-all active:scale-95 flex items-center justify-center gap-2 whitespace-nowrap ${variants[variant]} ${className} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}>
                    {children}
                </button>
            );
        };

        const ProgressBar = ({ current, max, colorClass = "bg-indigo-500", height = "h-2" }) => {
            const percentage = Math.min(100, Math.max(0, (current / max) * 100));
            return (
                <div className={`${height} w-full bg-slate-900 rounded-full overflow-hidden border border-slate-700`}>
                    <div className={`h-full transition-all duration-500 ease-out ${colorClass}`} style={{ width: `${percentage}%` }} />
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm px-4">
                    <div className="bg-slate-800 border border-slate-600 w-full max-w-sm rounded-2xl shadow-2xl flex flex-col max-h-[85vh] animate-slide-in">
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center shrink-0">
                            <h3 className="text-lg font-bold text-white">{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-white p-1"><X size={24} /></button>
                        </div>
                        <div className="p-4 overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const Notification = ({ message, type, onClose }) => {
            if (!message) return null;
            const bgColors = { success: "bg-emerald-600", error: "bg-red-600", info: "bg-indigo-600" };
            return (
                <div className={`fixed bottom-8 left-1/2 transform -translate-x-1/2 z-[60] flex items-center justify-between gap-3 px-4 py-3 rounded-lg shadow-2xl text-white ${bgColors[type] || bgColors.info} animate-slide-in w-[90%] max-w-sm`}>
                    <span className="truncate text-sm font-medium">{message}</span>
                    <button onClick={onClose} className="opacity-80 hover:opacity-100 flex-shrink-0"><X size={18} /></button>
                </div>
            );
        };

        // --- 主程式 ---
        function LifeRPG() {
            const [user, setUser] = React.useState(() => {
                const saved = localStorage.getItem('liferpg-user-v2');
                if (saved) return JSON.parse(saved);
                return { base: { level: 1, xp: 0, maxXp: 100 }, job: { level: 1, xp: 0, maxXp: 100 }, totalTasksCompleted: 0 };
            });

            function getWeekNumber(d) {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                return Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            }

            const [appState, setAppState] = React.useState(() => {
                const saved = localStorage.getItem('liferpg-app-state');
                return saved ? JSON.parse(saved) : { lastVisitDate: new Date().toDateString(), lastVisitWeek: getWeekNumber(new Date()) };
            });

            const [tasks, setTasks] = React.useState(() => {
                const saved = localStorage.getItem('liferpg-tasks');
                return saved ? JSON.parse(saved) : [
                    { id: 1, title: "遛狗", category: "fitness", xp: 30, completed: false, repeat: 'daily' },
                    { id: 2, title: "健身/運動", category: "fitness", xp: 50, completed: false, repeat: 'daily' },
                    { id: 3, title: "洗衣服", category: "chores", xp: 40, completed: false, repeat: 'weekly' },
                ];
            });

            const [rewards, setRewards] = React.useState(() => {
                const saved = localStorage.getItem('liferpg-rewards-v2');
                return saved ? JSON.parse(saved) : [
                    { id: 1, title: "放縱餐 (Cheat Meal)", reqType: 'base', levelReq: 2, unlocked: false },
                    { id: 2, title: "買新遊戲", reqType: 'job', levelReq: 5, unlocked: false },
                ];
            });

            const [history, setHistory] = React.useState(() => {
                const saved = localStorage.getItem('liferpg-history');
                return saved ? JSON.parse(saved) : [];
            });

            const [activeTab, setActiveTab] = React.useState('tasks');
            const [questFilter, setQuestFilter] = React.useState('all'); 
            const [levelUpData, setLevelUpData] = React.useState(null);
            const [notification, setNotification] = React.useState(null); 
            const [showSettings, setShowSettings] = React.useState(false);

            const [newTask, setNewTask] = React.useState({ title: '', category: 'fitness', xp: 20, repeat: 'daily' });
            const [newReward, setNewReward] = React.useState({ title: '', reqType: 'base', levelReq: 2 });

             const categories = {
                fitness: { type: 'base', color: "text-red-400", bg: "bg-red-500/10", border: "border-red-500/20", icon: <Dumbbell size={18} />, label: "運動健康" },
                chores: { type: 'base', color: "text-blue-400", bg: "bg-blue-500/10", border: "border-blue-500/20", icon: <Home size={18} />, label: "居家雜務" },
                knowledge: { type: 'job', color: "text-purple-400", bg: "bg-purple-500/10", border: "border-purple-500/20", icon: <BookOpen size={18} />, label: "專業知識" },
                finance: { type: 'job', color: "text-emerald-400", bg: "bg-emerald-500/10", border: "border-emerald-500/20", icon: <TrendingUp size={18} />, label: "理財投資" },
                general: { type: 'base', color: "text-slate-400", bg: "bg-slate-500/10", border: "border-slate-500/20", icon: <Star size={18} />, label: "一般任務" },
            };

            const showNotification = (message, type = 'info') => {
                setNotification({ message, type });
                setTimeout(() => setNotification(null), 3000);
            };

            // Effects & Logic
            React.useEffect(() => { localStorage.setItem('liferpg-user-v2', JSON.stringify(user)); }, [user]);
            React.useEffect(() => { localStorage.setItem('liferpg-tasks', JSON.stringify(tasks)); }, [tasks]);
            React.useEffect(() => { localStorage.setItem('liferpg-rewards-v2', JSON.stringify(rewards)); }, [rewards]);
            React.useEffect(() => { localStorage.setItem('liferpg-history', JSON.stringify(history)); }, [history]);
            React.useEffect(() => { localStorage.setItem('liferpg-app-state', JSON.stringify(appState)); }, [appState]);

            React.useEffect(() => {
                const today = new Date();
                const todayString = today.toDateString();
                const currentWeek = getWeekNumber(today);
                let updatedTasks = [...tasks];
                let tasksChanged = false;
                if (appState.lastVisitDate !== todayString) {
                    updatedTasks = updatedTasks.map(t => {
                        if (t.repeat === 'daily' && t.completed) { tasksChanged = true; return { ...t, completed: false }; }
                        return t;
                    });
                }
                if (appState.lastVisitWeek !== currentWeek) {
                    updatedTasks = updatedTasks.map(t => {
                        if (t.repeat === 'weekly' && t.completed) { tasksChanged = true; return { ...t, completed: false }; }
                        return t;
                    });
                }
                if (tasksChanged) { setTasks(updatedTasks); showNotification("每日/每週任務已重置！", "info"); }
                setAppState({ lastVisitDate: todayString, lastVisitWeek: currentWeek });
            }, []);

            const handleCompleteTask = (taskId) => {
                const task = tasks.find(t => t.id === taskId);
                if (task.completed) return;
                setTasks(tasks.map(t => t.id === taskId ? { ...t, completed: true } : t));
                setHistory(prev => [{ logId: Date.now(), title: task.title, category: task.category, xp: task.xp, completedAt: new Date().toISOString() }, ...prev]);
                addXP(task.xp, task.category);
            };

            const addXP = (amount, categoryKey) => {
                const category = categories[categoryKey] || categories.general;
                const type = category.type;
                setUser(prev => {
                    let currentStats = { ...prev[type] };
                    let newXP = currentStats.xp + amount;
                    let newLevel = currentStats.level;
                    let newMaxXp = currentStats.maxXp;
                    let leveledUp = false;
                    while (newXP >= newMaxXp) { newXP -= newMaxXp; newLevel++; newMaxXp = Math.floor(newMaxXp * 1.2); leveledUp = true; }
                    if (leveledUp) { setTimeout(() => setLevelUpData({ type, level: newLevel }), 100); }
                    return { ...prev, [type]: { level: newLevel, xp: newXP, maxXp: newMaxXp }, totalTasksCompleted: prev.totalTasksCompleted + 1 };
                });
            };

            const handleManualReset = () => {
                if(window.confirm("重置所有任務狀態？")) { setTasks(tasks.map(t => ({ ...t, completed: false }))); showNotification("已重置", "info"); setShowSettings(false); }
            };
            const handleDeleteTask = (id) => { setTasks(tasks.filter(t => t.id !== id)); showNotification("任務已刪除", "error"); };
            const handleAddTask = (e) => {
                e.preventDefault();
                if (!newTask.title.trim()) return;
                setTasks([...tasks, { id: Date.now(), title: newTask.title, category: newTask.category, xp: parseInt(newTask.xp), repeat: newTask.repeat, completed: false }]);
                setNewTask({ title: '', category: 'fitness', xp: 20, repeat: 'daily' });
                showNotification("新增成功", "success");
            };
            const handleAddReward = (e) => {
                e.preventDefault();
                if (!newReward.title.trim()) return;
                setRewards([...rewards, { id: Date.now(), title: newReward.title, reqType: newReward.reqType, levelReq: parseInt(newReward.levelReq), unlocked: false }]);
                setNewReward(prev => ({ ...prev, title: '' }));
                showNotification("新增獎勵", "success");
            };
            const handleDeleteReward = (id) => { setRewards(rewards.filter(r => r.id !== id)); };
            const handleClearHistory = () => { if(window.confirm("清除所有紀錄？")) { setHistory([]); showNotification("紀錄已清除", "info"); setShowSettings(false); } };

            const handleExportData = () => {
                const data = { user, tasks, rewards, history, appState, version: "1.0" };
                const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `liferpg_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification("備份已下載！", "success");
            };

            const handleImportData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if(data.user) setUser(data.user);
                        if(data.tasks) setTasks(data.tasks);
                        if(data.rewards) setRewards(data.rewards);
                        if(data.history) setHistory(data.history);
                        if(data.appState) setAppState(data.appState);
                        showNotification("還原成功！", "success");
                        setShowSettings(false);
                    } catch (err) {
                        showNotification("檔案格式錯誤", "error");
                    }
                };
                reader.readAsText(file);
            };

            const handleImportStarterPack = () => {
                if(!window.confirm("匯入新手包？")) return;
                mergePack([
                    { id: 1001, title: "遛狗", category: "fitness", xp: 30, repeat: 'daily' }, { id: 1002, title: "運動", category: "fitness", xp: 50, repeat: 'daily' },
                    { id: 1008, title: "喝水 2000cc", category: "fitness", xp: 10, repeat: 'daily' }, { id: 1009, title: "檢視開銷", category: "finance", xp: 20, repeat: 'daily' }
                ], "新手包");
            };

            const handleImportEngineerPack = () => {
                if(!window.confirm("匯入環工/理財包？")) return;
                mergePack([
                    { id: 2001, title: "考取環工技師 (PE)", category: "knowledge", xp: 100, repeat: 'none' }, { id: 2004, title: "番茄鐘環評 (4x25m)", category: "knowledge", xp: 20, repeat: 'daily' },
                    { id: 2006, title: "零支出挑戰", category: "finance", xp: 30, repeat: 'daily' }, { id: 2008, title: "轉帳工程款", category: "finance", xp: 50, repeat: 'weekly' }
                ], "環工包");
            };

            const mergePack = (pack, name) => {
                const newT = pack.filter(n => !tasks.some(e => e.title.trim() === n.title.trim())).map(t => ({...t, id: Date.now() + Math.random(), completed: false}));
                if (newT.length === 0) { showNotification("你已有這些任務", "info"); return; }
                setTasks(p => [...p, ...newT]);
                showNotification(`已匯入 ${name}`, "success");
            }

            const getHistoryByDate = () => {
                const groups = {};
                history.forEach(entry => {
                    const date = new Date(entry.completedAt).toLocaleDateString('zh-TW', { month: 'short', day: 'numeric', weekday: 'short' });
                    if (!groups[date]) groups[date] = [];
                    groups[date].push(entry);
                });
                return groups;
            };

            const filteredTasks = tasks.filter(task => {
                if (questFilter === 'all') return true;
                const cat = categories[task.category] || categories.general;
                return cat.type === questFilter;
            });

            return (
                <div className="w-full min-h-full flex flex-col">
                    {notification && <Notification message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}

                    {/* Header */}
                    <div className="bg-slate-900 border-b border-slate-800 sticky top-0 z-30 shadow-2xl w-full pt-safe px-4 pb-4 shrink-0">
                        <div className="w-full max-w-lg mx-auto space-y-4">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h1 className="text-xl font-bold bg-gradient-to-r from-indigo-400 to-cyan-400 bg-clip-text text-transparent">人生 RPG</h1>
                                    <div className="text-xs text-slate-500 font-mono">完成 {user.totalTasksCompleted} 任務</div>
                                </div>
                                <button onClick={() => setShowSettings(true)} className="p-2 rounded-full bg-slate-800 text-slate-400 hover:text-white border border-slate-700">
                                    <Settings size={20} />
                                </button>
                            </div>
                            <div className="space-y-2">
                                <div className="space-y-1">
                                    <div className="flex justify-between text-[10px] font-bold uppercase tracking-wider"><span className="flex items-center gap-1 text-rose-400"><Heart size={10} /> 生活 LV {user.base.level}</span><span className="text-slate-500">{user.base.xp}/{user.base.maxXp}</span></div>
                                    <ProgressBar current={user.base.xp} max={user.base.maxXp} colorClass="bg-gradient-to-r from-rose-500 to-pink-500" height="h-1.5" />
                                </div>
                                <div className="space-y-1">
                                    <div className="flex justify-between text-[10px] font-bold uppercase tracking-wider"><span className="flex items-center gap-1 text-cyan-400"><Briefcase size={10} /> 職涯 LV {user.job.level}</span><span className="text-slate-500">{user.job.xp}/{user.job.maxXp}</span></div>
                                    <ProgressBar current={user.job.xp} max={user.job.maxXp} colorClass="bg-gradient-to-r from-cyan-500 to-blue-500" height="h-1.5" />
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Scrollable Content Area */}
                    <main className="flex-1 w-full max-w-lg mx-auto p-4 pb-32 overflow-x-hidden">
                        
                        {/* Tabs - Grid Layout ensures fit */}
                        <div className="grid grid-cols-3 gap-2 mb-6 w-full">
                            <button onClick={() => setActiveTab('tasks')} className={`py-2 rounded-lg font-bold flex items-center justify-center gap-1 text-sm ${activeTab === 'tasks' ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-400'}`}><CheckCircle2 size={16} /> 任務</button>
                            <button onClick={() => setActiveTab('rewards')} className={`py-2 rounded-lg font-bold flex items-center justify-center gap-1 text-sm ${activeTab === 'rewards' ? 'bg-amber-600 text-white' : 'bg-slate-800 text-slate-400'}`}><Trophy size={16} /> 獎勵</button>
                            <button onClick={() => setActiveTab('history')} className={`py-2 rounded-lg font-bold flex items-center justify-center gap-1 text-sm ${activeTab === 'history' ? 'bg-teal-600 text-white' : 'bg-slate-800 text-slate-400'}`}><Calendar size={16} /> 紀錄</button>
                        </div>

                        {/* Tasks Tab */}
                        {activeTab === 'tasks' && (
                            <div className="space-y-4 w-full">
                                {/* Filter - Grid Layout */}
                                <div className="bg-slate-900 p-1 rounded-xl border border-slate-800 grid grid-cols-3 gap-1 w-full">
                                    <button onClick={() => setQuestFilter('all')} className={`py-2 text-xs font-medium rounded-lg ${questFilter === 'all' ? 'bg-indigo-600 text-white' : 'text-slate-400'}`}>全部</button>
                                    <button onClick={() => setQuestFilter('base')} className={`py-2 text-xs font-medium rounded-lg ${questFilter === 'base' ? 'bg-rose-600 text-white' : 'text-slate-400'}`}>基礎</button>
                                    <button onClick={() => setQuestFilter('job')} className={`py-2 text-xs font-medium rounded-lg ${questFilter === 'job' ? 'bg-cyan-600 text-white' : 'text-slate-400'}`}>職涯</button>
                                </div>

                                {/* Add Task Form - Responsive Stack */}
                                <Card className="p-3 bg-slate-900/50">
                                    <form onSubmit={handleAddTask} className="flex flex-col gap-3 w-full">
                                        <input type="text" placeholder="輸入任務名稱..." className="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-3 text-white focus:outline-none focus:border-indigo-500 text-sm" value={newTask.title} onChange={(e) => setNewTask({...newTask, title: e.target.value})} />
                                        
                                        <div className="grid grid-cols-2 gap-2 w-full">
                                            <select className="bg-slate-800 border border-slate-600 rounded-lg px-2 py-2 text-slate-300 text-sm w-full" value={newTask.category} onChange={(e) => setNewTask({...newTask, category: e.target.value})}>
                                                {Object.entries(categories).map(([key, val]) => <option key={key} value={key}>{val.label}</option>)}
                                            </select>
                                            <select className="bg-slate-800 border border-slate-600 rounded-lg px-2 py-2 text-slate-300 text-sm w-full" value={newTask.repeat} onChange={(e) => setNewTask({...newTask, repeat: e.target.value})}>
                                                <option value="daily">每日</option>
                                                <option value="weekly">每週</option>
                                                <option value="none">一次</option>
                                            </select>
                                        </div>
                                        
                                        <div className="grid grid-cols-3 gap-2 w-full">
                                             <select className="col-span-2 bg-slate-800 border border-slate-600 rounded-lg px-2 py-2 text-slate-300 text-sm w-full" value={newTask.xp} onChange={(e) => setNewTask({...newTask, xp: e.target.value})}>
                                                <option value="10">10 XP</option>
                                                <option value="20">20 XP</option>
                                                <option value="30">30 XP</option>
                                                <option value="50">50 XP</option>
                                            </select>
                                            <Button variant="primary" className="py-2 text-sm"><Plus size={18} /></Button>
                                        </div>
                                    </form>
                                </Card>

                                <div className="flex flex-wrap justify-between items-center gap-2 w-full">
                                    <h2 className="text-sm font-bold text-white">進行中 ({filteredTasks.length})</h2>
                                    <div className="flex gap-2">
                                        <button onClick={handleImportEngineerPack} className="text-xs flex items-center gap-1 text-cyan-400 border border-cyan-500/20 rounded px-2 py-1 bg-cyan-950/30"><HardHat size={12} /> 環工</button>
                                        <button onClick={handleImportStarterPack} className="text-xs flex items-center gap-1 text-indigo-400 border border-indigo-500/20 rounded px-2 py-1 bg-indigo-950/30"><Download size={12} /> 新手</button>
                                    </div>
                                </div>

                                <div className="space-y-3 w-full">
                                    {filteredTasks.length === 0 && <div className="text-center py-12 text-slate-500 italic text-sm">暫無任務</div>}
                                    {filteredTasks.sort((a,b) => (a.completed === b.completed) ? 0 : a.completed ? 1 : -1).map((task) => {
                                        const cat = categories[task.category] || categories.general;
                                        const xpType = cat.type === 'base' ? '基礎' : '職涯';
                                        const xpColor = cat.type === 'base' ? 'text-rose-400' : 'text-cyan-400';
                                        return (
                                            <div key={task.id} className={`relative flex items-center justify-between p-3 rounded-xl border w-full ${task.completed ? 'bg-slate-900/50 border-slate-800 opacity-60' : `bg-slate-800 ${cat.border} shadow-lg`}`}>
                                                <div className="flex items-center gap-3 overflow-hidden flex-1 min-w-0">
                                                    <button onClick={() => handleCompleteTask(task.id)} disabled={task.completed} className={`shrink-0 h-8 w-8 rounded-full flex items-center justify-center border-2 ${task.completed ? 'bg-green-500/20 border-green-500 text-green-500' : 'bg-slate-700 border-slate-600 text-slate-500'}`}>
                                                        {task.completed ? <CheckCircle2 size={16} /> : <div className="h-2 w-2 rounded-full bg-current opacity-20" />}
                                                    </button>
                                                    <div className="min-w-0 flex-1">
                                                        <div className="flex flex-wrap items-center gap-2 mb-0.5">
                                                            <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded-full flex items-center gap-1 ${cat.color} ${cat.bg}`}>{cat.icon} {cat.label}</span>
                                                            <span className={`text-[10px] font-mono ${xpColor}`}>+{task.xp} {xpType}</span>
                                                        </div>
                                                        <h3 className={`font-medium truncate text-sm ${task.completed ? 'line-through text-slate-500' : 'text-white'}`}>{task.title}</h3>
                                                    </div>
                                                </div>
                                                <button onClick={() => handleDeleteTask(task.id)} className="p-2 text-slate-500 hover:text-red-400 ml-1 shrink-0"><Trash2 size={16} /></button>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* Rewards Tab */}
                        {activeTab === 'rewards' && (
                            <div className="space-y-4 animate-slide-in w-full">
                                <Card className="p-3 bg-slate-900/50">
                                    <div className="flex flex-col gap-3 w-full">
                                        <input type="text" placeholder="獎勵名稱" className="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-3 text-white text-sm focus:outline-none" value={newReward.title} onChange={(e) => setNewReward({...newReward, title: e.target.value})} />
                                        <div className="grid grid-cols-3 gap-2">
                                            <select className="col-span-1 bg-slate-800 border border-slate-600 rounded-lg px-2 py-2 text-slate-300 text-sm" value={newReward.reqType} onChange={(e) => setNewReward({...newReward, reqType: e.target.value})}>
                                                <option value="base">基礎</option>
                                                <option value="job">職涯</option>
                                            </select>
                                            <input type="number" placeholder="等級" className="col-span-1 bg-slate-800 border border-slate-600 rounded-lg px-2 py-2 text-white text-sm" value={newReward.levelReq} onChange={(e) => setNewReward({...newReward, levelReq: e.target.value})} />
                                            <Button variant="primary" onClick={handleAddReward} className="py-2 text-sm"><Plus size={18} /></Button>
                                        </div>
                                    </div>
                                </Card>
                                <div className="grid grid-cols-1 gap-3 pb-12">
                                    {rewards.sort((a,b) => a.levelReq - b.levelReq).map((reward) => {
                                        const isUnlocked = (reward.reqType === 'base' ? user.base.level : user.job.level) >= reward.levelReq;
                                        return (
                                            <div key={reward.id} className={`relative p-4 rounded-xl border flex items-center justify-between ${isUnlocked ? 'bg-gradient-to-br from-amber-900/20 to-slate-800 border-amber-500/30' : 'bg-slate-800 border-slate-700 opacity-75'}`}>
                                                <div className="flex items-center gap-3">
                                                    <div className={`p-2 rounded-lg ${isUnlocked ? 'bg-amber-500/20 text-amber-400' : 'bg-slate-700 text-slate-500'}`}>{isUnlocked ? <Unlock size={20} /> : <Lock size={20} />}</div>
                                                    <div>
                                                        <h3 className={`font-bold text-sm ${isUnlocked ? 'text-white' : 'text-slate-400'}`}>{reward.title}</h3>
                                                        <p className={`text-xs ${isUnlocked ? 'text-green-400' : 'text-red-400'}`}>{isUnlocked ? '已解鎖' : `需 ${reward.reqType === 'base' ? '基礎' : '職涯'} LV ${reward.levelReq}`}</p>
                                                    </div>
                                                </div>
                                                <button onClick={() => handleDeleteReward(reward.id)} className="text-slate-600 hover:text-red-400"><Trash2 size={16} /></button>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                         {activeTab === 'history' && (
                             <div className="space-y-6 animate-slide-in w-full pb-12">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-sm font-bold text-white">紀錄</h2>
                                    <button onClick={handleClearHistory} className="text-xs flex items-center gap-1 text-slate-400 hover:text-red-400"><Trash2 size={12} /> 清除</button>
                                </div>
                                {history.length === 0 ? <div className="text-center py-12 text-slate-500 italic border border-dashed border-slate-800 rounded-xl text-sm">尚無紀錄</div> : (
                                    <div className="space-y-6 relative before:absolute before:left-3 before:top-2 before:bottom-2 before:w-0.5 before:bg-slate-800">
                                        {Object.entries(getHistoryByDate()).map(([date, entries]) => (
                                            <div key={date} className="relative pl-8">
                                                <div className="absolute left-1.5 top-0 w-3 h-3 bg-slate-700 rounded-full border-2 border-slate-950 transform -translate-x-1/2 z-10"></div>
                                                <div className="mb-2"><span className="text-xs font-bold text-slate-400 bg-slate-900/80 px-2 py-0.5 rounded">{date}</span></div>
                                                <div className="space-y-2">
                                                    {entries.map(entry => (
                                                        <div key={entry.logId} className="bg-slate-900 border border-slate-800 p-2 rounded-lg flex items-center justify-between">
                                                            <div className="flex items-center gap-2 overflow-hidden">
                                                                <div className={`w-2 h-2 shrink-0 rounded-full ${(categories[entry.category] || categories.general).bg}`}></div>
                                                                <span className="text-sm text-slate-200 truncate">{entry.title}</span>
                                                            </div>
                                                            <span className="text-xs text-indigo-400 shrink-0">+{entry.xp}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    {/* Settings Modal */}
                    <Modal isOpen={showSettings} onClose={() => setShowSettings(false)} title="設定">
                        <div className="space-y-4 w-full">
                            <div className="bg-slate-900 p-4 rounded-xl space-y-3 border border-slate-700">
                                <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider">資料備份</h4>
                                <p className="text-xs text-slate-500">存檔至手機/電腦，或還原進度。</p>
                                <div className="grid grid-cols-2 gap-2">
                                    <button onClick={handleExportData} className="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white py-2.5 rounded-lg text-xs"><Save size={14} /> 匯出</button>
                                    <label className="flex items-center justify-center gap-2 bg-slate-700 hover:bg-slate-600 text-white py-2.5 rounded-lg text-xs cursor-pointer">
                                        <Upload size={14} /> 匯入
                                        <input type="file" accept=".json" className="hidden" onChange={handleImportData} />
                                    </label>
                                </div>
                            </div>
                            <div className="bg-slate-900 p-4 rounded-xl space-y-3 border border-slate-700">
                                <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider">危險操作</h4>
                                <div className="grid grid-cols-1 gap-2">
                                    <button onClick={handleManualReset} className="flex items-center justify-center gap-2 bg-slate-800 border border-slate-700 text-slate-300 py-2.5 rounded-lg text-xs"><RefreshCw size={14} /> 重置每日任務</button>
                                    <button onClick={handleClearHistory} className="flex items-center justify-center gap-2 bg-red-900/20 border border-red-900/50 text-red-400 py-2.5 rounded-lg text-xs"><Trash2 size={14} /> 清除所有紀錄</button>
                                </div>
                            </div>
                        </div>
                    </Modal>

                    <Modal isOpen={!!levelUpData} onClose={() => setLevelUpData(null)} title="升級！">
                        <div className="text-center space-y-4">
                            <div className="mx-auto h-20 w-20 rounded-full bg-rose-500 flex items-center justify-center animate-bounce text-white"><Heart size={40} /></div>
                            <h2 className="text-3xl font-black text-white">LV {levelUpData?.level}</h2>
                            <Button onClick={() => setLevelUpData(null)} variant="primary" className="w-full">繼續</Button>
                        </div>
                    </Modal>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LifeRPG />);
    </script>
</body>
</html>
